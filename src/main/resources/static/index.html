<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phoebe - ç®¡ç†æ§åˆ¶å°</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #818cf8;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --bg-hover: #334155;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --border: #334155;
            --shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans SC', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, var(--bg-dark) 0%, #1a1a2e 100%);
            min-height: 100vh;
            color: var(--text-primary);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
            padding: 20px 0;
            border-bottom: 1px solid var(--border);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .logo-text {
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary-light) 0%, var(--primary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 32px;
            background: var(--bg-card);
            padding: 6px;
            border-radius: 16px;
            border: 1px solid var(--border);
            width: fit-content;
        }

        .tab {
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tab:hover {
            color: var(--text-primary);
            background: var(--bg-hover);
        }

        .tab.active {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow);
            border-color: var(--primary);
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stat-value {
            font-size: 36px;
            font-weight: 700;
        }

        .stat-value.primary { color: var(--primary-light); }
        .stat-value.success { color: var(--success); }
        .stat-value.danger { color: var(--danger); }
        .stat-value.warning { color: var(--warning); }
        .stat-value.info { color: var(--info); }

        .toolbar {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 300px;
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 14px 20px 14px 48px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 15px;
            transition: all 0.3s ease;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }

        .search-box::before {
            content: "ğŸ”";
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 18px;
        }

        .btn {
            padding: 14px 28px;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(99, 102, 241, 0.4);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-ghost {
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }

        .btn-ghost:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 13px;
        }

        .table-container {
            background: var(--bg-card);
            border-radius: 16px;
            border: 1px solid var(--border);
            overflow: hidden;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 16px 20px;
            text-align: left;
        }

        th {
            background: rgba(99, 102, 241, 0.1);
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        tr {
            border-bottom: 1px solid var(--border);
            transition: background 0.2s ease;
        }

        tr:hover {
            background: var(--bg-hover);
        }

        tr:last-child {
            border-bottom: none;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 16px;
        }

        .user-name {
            font-weight: 600;
        }

        .user-email {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-active, .badge-available {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success);
        }

        .badge-disabled {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger);
        }

        .badge-assigned {
            background: rgba(99, 102, 241, 0.15);
            color: var(--primary-light);
        }

        .badge-warning {
            background: rgba(245, 158, 11, 0.15);
            color: var(--warning);
        }

        .actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .index-id {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 13px;
            background: var(--bg-dark);
            padding: 4px 8px;
            border-radius: 6px;
            color: var(--primary-light);
        }

        .category-id {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 11px;
            color: var(--text-secondary);
            word-break: break-all;
            max-width: 200px;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 32px;
            width: 100%;
            max-width: 500px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            animation: modalIn 0.3s ease;
        }

        .modal.wide {
            max-width: 600px;
        }

        @keyframes modalIn {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .modal-title {
            font-size: 22px;
            font-weight: 700;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 24px;
            cursor: pointer;
            padding: 4px;
        }

        .modal-close:hover {
            color: var(--text-primary);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 14px 16px;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 15px;
            transition: all 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }

        .form-hint {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 6px;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 28px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 16px;
        }

        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            padding: 16px 24px;
            border-radius: 12px;
            color: white;
            font-weight: 500;
            transform: translateX(120%);
            transition: transform 0.3s ease;
            z-index: 2000;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success { background: var(--success); }
        .toast.error { background: var(--danger); }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .info-box {
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 24px;
        }

        .info-box h4 {
            color: var(--primary-light);
            margin-bottom: 8px;
            font-size: 14px;
        }

        .info-box p {
            color: var(--text-secondary);
            font-size: 13px;
            line-height: 1.6;
        }

        .assigned-user-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .assigned-user-info .mini-avatar {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <div class="logo-icon">ğŸ¦‹</div>
                <span class="logo-text">Phoebe ç®¡ç†æ§åˆ¶å°</span>
            </div>
            <nav>
                <button class="btn btn-ghost" onclick="refreshCurrentTab()">ğŸ”„ åˆ·æ–°</button>
            </nav>
        </header>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('users')" id="tab-users">
                ğŸ‘¥ ç”¨æˆ·ç®¡ç†
            </button>
            <button class="tab" onclick="switchTab('index-pool')" id="tab-index-pool">
                ğŸ—„ï¸ ç´¢å¼•æ± ç®¡ç†
            </button>
        </div>

        <!-- Users Tab Content -->
        <div class="tab-content active" id="content-users">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">ğŸ‘¥ æ€»ç”¨æˆ·æ•°</div>
                    <div class="stat-value primary" id="stat-total">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">âœ… æ´»è·ƒç”¨æˆ·</div>
                    <div class="stat-value success" id="stat-active">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">ğŸš« å·²ç¦ç”¨</div>
                    <div class="stat-value danger" id="stat-disabled">-</div>
                </div>
            </div>

            <div class="toolbar">
                <div class="search-box">
                    <input type="text" id="search-input" placeholder="æœç´¢ç”¨æˆ·åã€é‚®ç®±æˆ–æ˜µç§°..." onkeyup="handleUserSearch(event)">
                </div>
                <button class="btn btn-primary" onclick="openCreateUserModal()">
                    <span>â•</span> æ–°å»ºç”¨æˆ·
                </button>
            </div>

            <div class="table-container">
                <div class="loading" id="user-loading">
                    <div class="spinner"></div>
                    <div>åŠ è½½ä¸­...</div>
                </div>
                <table id="user-table">
                    <thead>
                        <tr>
                            <th>ç”¨æˆ·</th>
                            <th>æ‰‹æœºå·</th>
                            <th>çŸ¥è¯†åº“ç´¢å¼•</th>
                            <th>çŠ¶æ€</th>
                            <th>æ³¨å†Œæ—¶é—´</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="user-tbody">
                    </tbody>
                </table>
                <div class="empty-state" id="user-empty" style="display: none;">
                    <div class="empty-state-icon">ğŸ‘¥</div>
                    <div>æš‚æ— ç”¨æˆ·æ•°æ®</div>
                </div>
            </div>
        </div>

        <!-- Index Pool Tab Content -->
        <div class="tab-content" id="content-index-pool">
            <div class="info-box">
                <h4>ğŸ’¡ å…³äºçŸ¥è¯†åº“ç´¢å¼•æ± </h4>
                <p>æ¯ä¸ªç”¨æˆ·éœ€è¦ä¸€ä¸ªç‹¬ç«‹çš„ç™¾ç‚¼çŸ¥è¯†åº“ç´¢å¼•æ¥å­˜å‚¨ä»–ä»¬çš„å­¦ä¹ ç¬”è®°ã€‚åœ¨æ³¨å†Œæ–°ç”¨æˆ·æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ä»ç´¢å¼•æ± ä¸­åˆ†é…ä¸€ä¸ªå¯ç”¨ç´¢å¼•ç»™è¯¥ç”¨æˆ·ã€‚è¯·ç¡®ä¿ç´¢å¼•æ± ä¸­æœ‰è¶³å¤Ÿçš„å¯ç”¨ç´¢å¼•ä»¥æ”¯æŒæ–°ç”¨æˆ·æ³¨å†Œã€‚</p>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">ğŸ“¦ æ€»ç´¢å¼•æ•°</div>
                    <div class="stat-value primary" id="pool-total">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">âœ… å¯ç”¨ç´¢å¼•</div>
                    <div class="stat-value success" id="pool-available">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">ğŸ‘¤ å·²åˆ†é…</div>
                    <div class="stat-value info" id="pool-assigned">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">ğŸš« å·²ç¦ç”¨</div>
                    <div class="stat-value danger" id="pool-disabled">-</div>
                </div>
            </div>

            <div class="toolbar">
                <button class="btn btn-primary" onclick="openAddIndexModal()">
                    <span>â•</span> æ·»åŠ ç´¢å¼•
                </button>
                <button class="btn btn-ghost" onclick="openBatchAddModal()">
                    <span>ğŸ“¦</span> æ‰¹é‡æ·»åŠ 
                </button>
            </div>

            <div class="table-container">
                <div class="loading" id="pool-loading">
                    <div class="spinner"></div>
                    <div>åŠ è½½ä¸­...</div>
                </div>
                <table id="pool-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>ç´¢å¼• ID</th>
                            <th>ç±»ç›® ID</th>
                            <th>åç§°</th>
                            <th>çŠ¶æ€</th>
                            <th>åˆ†é…ç”¨æˆ·</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="pool-tbody">
                    </tbody>
                </table>
                <div class="empty-state" id="pool-empty" style="display: none;">
                    <div class="empty-state-icon">ğŸ—„ï¸</div>
                    <div>ç´¢å¼•æ± ä¸ºç©ºï¼Œè¯·æ·»åŠ ç´¢å¼•</div>
                </div>
            </div>
        </div>
    </div>

    <!-- User Create/Edit Modal -->
    <div class="modal-overlay" id="user-modal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title" id="user-modal-title">æ–°å»ºç”¨æˆ·</h2>
                <button class="modal-close" onclick="closeUserModal()">&times;</button>
            </div>
            <form id="user-form" onsubmit="handleUserSubmit(event)">
                <input type="hidden" id="user-id">
                <div class="form-group">
                    <label>ç”¨æˆ·å *</label>
                    <input type="text" id="username" required minlength="2" maxlength="50" placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
                </div>
                <div class="form-group">
                    <label id="password-label">å¯†ç  *</label>
                    <input type="password" id="password" minlength="6" maxlength="100" placeholder="è¯·è¾“å…¥å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰">
                    <div class="form-hint" id="password-hint" style="display: none;">ç•™ç©ºåˆ™ä¸ä¿®æ”¹å¯†ç </div>
                </div>
                <div class="form-group">
                    <label>æ˜µç§°</label>
                    <input type="text" id="nickname" maxlength="100" placeholder="è¯·è¾“å…¥æ˜µç§°">
                </div>
                <div class="form-group">
                    <label>é‚®ç®±</label>
                    <input type="email" id="email" placeholder="è¯·è¾“å…¥é‚®ç®±">
                </div>
                <div class="form-group">
                    <label>æ‰‹æœºå·</label>
                    <input type="tel" id="phone" placeholder="è¯·è¾“å…¥æ‰‹æœºå·">
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-ghost" onclick="closeUserModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary" id="user-submit-btn">åˆ›å»º</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Index Modal -->
    <div class="modal-overlay" id="index-modal">
        <div class="modal wide">
            <div class="modal-header">
                <h2 class="modal-title">æ·»åŠ ç´¢å¼•åˆ°æ± </h2>
                <button class="modal-close" onclick="closeIndexModal()">&times;</button>
            </div>
            <form id="index-form" onsubmit="handleIndexSubmit(event)">
                <div class="form-group">
                    <label>ç´¢å¼• ID *</label>
                    <input type="text" id="index-id" required placeholder="å¦‚: m71tmd04g9">
                    <div class="form-hint">åœ¨ç™¾ç‚¼æ§åˆ¶å°åˆ›å»ºçŸ¥è¯†åº“åè·å–çš„ç´¢å¼• ID</div>
                </div>
                <div class="form-group">
                    <label>ç±»ç›® ID *</label>
                    <input type="text" id="category-id" required placeholder="å¦‚: cate_xxx_10471186">
                    <div class="form-hint">æ•°æ®ä¸­å¿ƒçš„ç±»ç›® IDï¼Œç”¨äºæ–‡ä»¶ä¸Šä¼ </div>
                </div>
                <div class="form-group">
                    <label>åç§°æè¿°</label>
                    <input type="text" id="index-name" placeholder="å¦‚: ç”¨æˆ·çŸ¥è¯†åº“1">
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-ghost" onclick="closeIndexModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">æ·»åŠ </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Batch Add Modal -->
    <div class="modal-overlay" id="batch-modal">
        <div class="modal wide">
            <div class="modal-header">
                <h2 class="modal-title">æ‰¹é‡æ·»åŠ ç´¢å¼•</h2>
                <button class="modal-close" onclick="closeBatchModal()">&times;</button>
            </div>
            <form id="batch-form" onsubmit="handleBatchSubmit(event)">
                <div class="form-group">
                    <label>ç´¢å¼•æ•°æ® (JSON æ•°ç»„) *</label>
                    <textarea id="batch-data" rows="10" style="width: 100%; padding: 14px 16px; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 10px; color: var(--text-primary); font-family: Monaco, monospace; font-size: 13px; resize: vertical;" placeholder='[
  {"indexId": "xxx1", "categoryId": "cate_xxx", "indexName": "çŸ¥è¯†åº“1"},
  {"indexId": "xxx2", "categoryId": "cate_xxx", "indexName": "çŸ¥è¯†åº“2"}
]'></textarea>
                    <div class="form-hint">æ¯è¡Œä¸€ä¸ªç´¢å¼•é…ç½®ï¼Œæ ¼å¼ä¸º JSON æ•°ç»„</div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-ghost" onclick="closeBatchModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">æ‰¹é‡æ·»åŠ </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Assign Index Modal -->
    <div class="modal-overlay" id="assign-modal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">æ‰‹åŠ¨åˆ†é…ç´¢å¼•</h2>
                <button class="modal-close" onclick="closeAssignModal()">&times;</button>
            </div>
            <form id="assign-form" onsubmit="handleAssignSubmit(event)">
                <input type="hidden" id="assign-index-pool-id">
                <div class="form-group">
                    <label>ç´¢å¼• ID</label>
                    <input type="text" id="assign-index-id" readonly style="opacity: 0.7;">
                </div>
                <div class="form-group">
                    <label>é€‰æ‹©ç”¨æˆ· *</label>
                    <select id="assign-user-id" required>
                        <option value="">-- è¯·é€‰æ‹©ç”¨æˆ· --</option>
                    </select>
                    <div class="form-hint">åªæ˜¾ç¤ºå°šæœªåˆ†é…ç´¢å¼•çš„ç”¨æˆ·</div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-ghost" onclick="closeAssignModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-success">åˆ†é…ç´¢å¼•</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
        const USER_API = '/api/v1/users';
        const POOL_API = '/api/admin/index-pool';
        let currentTab = 'users';
        let editingUserId = null;
        let allUsers = [];

        // Tab switching
        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');
            document.getElementById(`content-${tab}`).classList.add('active');
            
            if (tab === 'users') {
                loadUserStats();
                loadUsers();
            } else if (tab === 'index-pool') {
                loadPoolStats();
                loadPool();
            }
        }

        function refreshCurrentTab() {
            switchTab(currentTab);
        }

        // ========================
        // User Management
        // ========================
        
        async function loadUserStats() {
            try {
                const res = await fetch(`${USER_API}/stats`);
                const data = await res.json();
                document.getElementById('stat-total').textContent = data.total;
                document.getElementById('stat-active').textContent = data.active;
                document.getElementById('stat-disabled').textContent = data.disabled;
            } catch (e) {
                console.error('Failed to load user stats:', e);
            }
        }

        async function loadUsers(keyword = '') {
            const loading = document.getElementById('user-loading');
            const tbody = document.getElementById('user-tbody');
            const empty = document.getElementById('user-empty');
            
            loading.classList.add('show');
            tbody.innerHTML = '';
            empty.style.display = 'none';

            try {
                let url = USER_API;
                if (keyword) {
                    url += `?keyword=${encodeURIComponent(keyword)}`;
                }
                const res = await fetch(url);
                const users = await res.json();
                allUsers = users;

                // Also load index pool to show user's assigned index
                const poolRes = await fetch(POOL_API);
                const poolData = await poolRes.json();
                const poolMap = {};
                poolData.forEach(p => {
                    if (p.assignedUserId) {
                        poolMap[p.assignedUserId] = p;
                    }
                });

                loading.classList.remove('show');

                if (users.length === 0) {
                    empty.style.display = 'block';
                    return;
                }

                users.forEach(user => {
                    const tr = document.createElement('tr');
                    const initial = (user.nickname || user.username || '?')[0].toUpperCase();
                    const statusClass = user.status === 1 ? 'badge-active' : 'badge-disabled';
                    const statusText = user.status === 1 ? 'æ´»è·ƒ' : 'ç¦ç”¨';
                    const assignedPool = poolMap[user.id];
                    
                    tr.innerHTML = `
                        <td>
                            <div class="user-info">
                                <div class="avatar">${initial}</div>
                                <div>
                                    <div class="user-name">${user.nickname || user.username}</div>
                                    <div class="user-email">${user.email || '-'}</div>
                                </div>
                            </div>
                        </td>
                        <td>${user.phone || '-'}</td>
                        <td>
                            ${assignedPool 
                                ? `<span class="index-id">${assignedPool.indexId}</span>` 
                                : '<span style="color: var(--warning)">æœªåˆ†é…</span>'
                            }
                        </td>
                        <td><span class="badge ${statusClass}">${statusText}</span></td>
                        <td>${formatDate(user.createdAt)}</td>
                        <td>
                            <div class="actions">
                                <button class="btn btn-ghost btn-sm" onclick="openEditUserModal(${user.id})">ç¼–è¾‘</button>
                                ${user.status === 1 
                                    ? `<button class="btn btn-ghost btn-sm" onclick="toggleUserStatus(${user.id}, 'disable')">ç¦ç”¨</button>`
                                    : `<button class="btn btn-ghost btn-sm" onclick="toggleUserStatus(${user.id}, 'enable')">å¯ç”¨</button>`
                                }
                                <button class="btn btn-ghost btn-sm" onclick="deleteUser(${user.id})" style="color: var(--danger)">åˆ é™¤</button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (e) {
                loading.classList.remove('show');
                showToast('åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥', 'error');
                console.error('Failed to load users:', e);
            }
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleDateString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        let searchTimeout;
        function handleUserSearch(event) {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                loadUsers(event.target.value);
            }, 300);
        }

        function openCreateUserModal() {
            editingUserId = null;
            document.getElementById('user-modal-title').textContent = 'æ–°å»ºç”¨æˆ·';
            document.getElementById('user-submit-btn').textContent = 'åˆ›å»º';
            document.getElementById('user-form').reset();
            // Password is required for new users
            document.getElementById('password').required = true;
            document.getElementById('password-label').textContent = 'å¯†ç  *';
            document.getElementById('password-hint').style.display = 'none';
            document.getElementById('user-modal').classList.add('active');
        }

        async function openEditUserModal(id) {
            try {
                const res = await fetch(`${USER_API}/${id}`);
                const user = await res.json();
                
                editingUserId = id;
                document.getElementById('user-modal-title').textContent = 'ç¼–è¾‘ç”¨æˆ·';
                document.getElementById('user-submit-btn').textContent = 'ä¿å­˜';
                document.getElementById('user-id').value = id;
                document.getElementById('username').value = user.username || '';
                document.getElementById('password').value = ''; // Clear password field
                document.getElementById('password').required = false; // Password is optional for edit
                document.getElementById('password-label').textContent = 'å¯†ç ';
                document.getElementById('password-hint').style.display = 'block';
                document.getElementById('nickname').value = user.nickname || '';
                document.getElementById('email').value = user.email || '';
                document.getElementById('phone').value = user.phone || '';
                document.getElementById('user-modal').classList.add('active');
            } catch (e) {
                showToast('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥', 'error');
            }
        }

        function closeUserModal() {
            document.getElementById('user-modal').classList.remove('active');
            editingUserId = null;
        }

        async function handleUserSubmit(event) {
            event.preventDefault();
            
            const password = document.getElementById('password').value;
            
            // Validate password for new users
            if (!editingUserId && (!password || password.length < 6)) {
                showToast('å¯†ç è‡³å°‘éœ€è¦6ä½', 'error');
                return;
            }
            
            const data = {
                username: document.getElementById('username').value,
                nickname: document.getElementById('nickname').value || null,
                email: document.getElementById('email').value || null,
                phone: document.getElementById('phone').value || null
            };
            
            // Only include password if it's provided (required for new, optional for edit)
            if (password) {
                data.password = password;
            }

            try {
                let res;
                if (editingUserId) {
                    res = await fetch(`${USER_API}/${editingUserId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                } else {
                    res = await fetch(USER_API, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                }

                const result = await res.json();
                
                if (!res.ok) {
                    showToast(result.error || 'æ“ä½œå¤±è´¥', 'error');
                    return;
                }

                showToast(editingUserId ? 'ç”¨æˆ·å·²æ›´æ–°' : 'ç”¨æˆ·å·²åˆ›å»º', 'success');
                closeUserModal();
                loadUsers();
                loadUserStats();
                loadPoolStats(); // Also refresh pool stats as a new user might have been assigned
            } catch (e) {
                showToast('æ“ä½œå¤±è´¥', 'error');
                console.error('Submit failed:', e);
            }
        }

        async function toggleUserStatus(id, action) {
            try {
                const res = await fetch(`${USER_API}/${id}/${action}`, { method: 'POST' });
                if (res.ok) {
                    showToast(action === 'enable' ? 'ç”¨æˆ·å·²å¯ç”¨' : 'ç”¨æˆ·å·²ç¦ç”¨', 'success');
                    loadUsers();
                    loadUserStats();
                } else {
                    const data = await res.json();
                    showToast(data.error || 'æ“ä½œå¤±è´¥', 'error');
                }
            } catch (e) {
                showToast('æ“ä½œå¤±è´¥', 'error');
            }
        }

        async function deleteUser(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤ç”¨æˆ·å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼ŒåŒæ—¶ä¼šé‡Šæ”¾è¯¥ç”¨æˆ·çš„çŸ¥è¯†åº“ç´¢å¼•ã€‚')) {
                return;
            }

            try {
                const res = await fetch(`${USER_API}/${id}`, { method: 'DELETE' });
                if (res.ok) {
                    showToast('ç”¨æˆ·å·²åˆ é™¤', 'success');
                    loadUsers();
                    loadUserStats();
                    loadPoolStats();
                } else {
                    const data = await res.json();
                    showToast(data.error || 'åˆ é™¤å¤±è´¥', 'error');
                }
            } catch (e) {
                showToast('åˆ é™¤å¤±è´¥', 'error');
            }
        }

        // ========================
        // Index Pool Management
        // ========================

        async function loadPoolStats() {
            try {
                const res = await fetch(`${POOL_API}/stats`);
                const data = await res.json();
                document.getElementById('pool-total').textContent = data.total;
                document.getElementById('pool-available').textContent = data.available;
                document.getElementById('pool-assigned').textContent = data.assigned;
                document.getElementById('pool-disabled').textContent = data.disabled;
            } catch (e) {
                console.error('Failed to load pool stats:', e);
            }
        }

        async function loadPool() {
            const loading = document.getElementById('pool-loading');
            const tbody = document.getElementById('pool-tbody');
            const empty = document.getElementById('pool-empty');
            
            loading.classList.add('show');
            tbody.innerHTML = '';
            empty.style.display = 'none';

            try {
                const res = await fetch(POOL_API);
                const indexes = await res.json();

                // Load users to show names
                const userRes = await fetch(USER_API);
                const users = await userRes.json();
                allUsers = users;
                const userMap = {};
                users.forEach(u => { userMap[u.id] = u; });

                loading.classList.remove('show');

                if (indexes.length === 0) {
                    empty.style.display = 'block';
                    return;
                }

                indexes.forEach(index => {
                    const tr = document.createElement('tr');
                    let statusBadge = '';
                    if (index.status === 'AVAILABLE') {
                        statusBadge = '<span class="badge badge-available">å¯ç”¨</span>';
                    } else if (index.status === 'ASSIGNED') {
                        statusBadge = '<span class="badge badge-assigned">å·²åˆ†é…</span>';
                    } else if (index.status === 'DISABLED') {
                        statusBadge = '<span class="badge badge-disabled">å·²ç¦ç”¨</span>';
                    }

                    const assignedUser = index.assignedUserId ? userMap[index.assignedUserId] : null;
                    let assignedUserHtml = '-';
                    if (assignedUser) {
                        const initial = (assignedUser.nickname || assignedUser.username || '?')[0].toUpperCase();
                        assignedUserHtml = `
                            <div class="assigned-user-info">
                                <div class="mini-avatar">${initial}</div>
                                <span>${assignedUser.nickname || assignedUser.username}</span>
                            </div>
                        `;
                    } else if (index.assignedUserId) {
                        assignedUserHtml = `<span style="color: var(--warning)">ID: ${index.assignedUserId}</span>`;
                    }

                    let actions = '';
                    if (index.status === 'AVAILABLE') {
                        actions = `
                            <button class="btn btn-ghost btn-sm" onclick="openAssignModal(${index.id}, '${index.indexId}')">åˆ†é…</button>
                            <button class="btn btn-ghost btn-sm" onclick="disableIndex(${index.id})">ç¦ç”¨</button>
                            <button class="btn btn-ghost btn-sm" onclick="deleteIndex(${index.id})" style="color: var(--danger)">åˆ é™¤</button>
                        `;
                    } else if (index.status === 'ASSIGNED') {
                        actions = `
                            <button class="btn btn-ghost btn-sm" onclick="releaseIndex(${index.assignedUserId})">é‡Šæ”¾</button>
                        `;
                    } else if (index.status === 'DISABLED') {
                        actions = `
                            <button class="btn btn-ghost btn-sm" onclick="enableIndex(${index.id})">å¯ç”¨</button>
                            <button class="btn btn-ghost btn-sm" onclick="deleteIndex(${index.id})" style="color: var(--danger)">åˆ é™¤</button>
                        `;
                    }
                    
                    tr.innerHTML = `
                        <td>${index.id}</td>
                        <td><span class="index-id">${index.indexId}</span></td>
                        <td><span class="category-id">${index.categoryId}</span></td>
                        <td>${index.indexName || '-'}</td>
                        <td>${statusBadge}</td>
                        <td>${assignedUserHtml}</td>
                        <td>
                            <div class="actions">${actions}</div>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (e) {
                loading.classList.remove('show');
                showToast('åŠ è½½ç´¢å¼•æ± å¤±è´¥', 'error');
                console.error('Failed to load pool:', e);
            }
        }

        function openAddIndexModal() {
            document.getElementById('index-form').reset();
            document.getElementById('index-modal').classList.add('active');
        }

        function closeIndexModal() {
            document.getElementById('index-modal').classList.remove('active');
        }

        async function handleIndexSubmit(event) {
            event.preventDefault();
            
            const data = {
                indexId: document.getElementById('index-id').value,
                categoryId: document.getElementById('category-id').value,
                indexName: document.getElementById('index-name').value || null
            };

            try {
                const res = await fetch(POOL_API, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (res.ok) {
                    showToast('ç´¢å¼•å·²æ·»åŠ åˆ°æ± ', 'success');
                    closeIndexModal();
                    loadPool();
                    loadPoolStats();
                } else {
                    showToast('æ·»åŠ å¤±è´¥ï¼Œç´¢å¼•å¯èƒ½å·²å­˜åœ¨', 'error');
                }
            } catch (e) {
                showToast('æ·»åŠ å¤±è´¥', 'error');
            }
        }

        function openBatchAddModal() {
            document.getElementById('batch-form').reset();
            document.getElementById('batch-modal').classList.add('active');
        }

        function closeBatchModal() {
            document.getElementById('batch-modal').classList.remove('active');
        }

        async function handleBatchSubmit(event) {
            event.preventDefault();
            
            try {
                const data = JSON.parse(document.getElementById('batch-data').value);
                
                const res = await fetch(`${POOL_API}/batch`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await res.json();
                showToast(`æˆåŠŸæ·»åŠ  ${result.added} ä¸ªç´¢å¼•`, 'success');
                closeBatchModal();
                loadPool();
                loadPoolStats();
            } catch (e) {
                showToast('JSON æ ¼å¼é”™è¯¯æˆ–æ·»åŠ å¤±è´¥', 'error');
            }
        }

        async function openAssignModal(poolId, indexId) {
            // Get users without assigned index
            try {
                const poolRes = await fetch(POOL_API);
                const poolData = await poolRes.json();
                const assignedUserIds = new Set(poolData.filter(p => p.assignedUserId).map(p => p.assignedUserId));

                document.getElementById('assign-index-pool-id').value = poolId;
                document.getElementById('assign-index-id').value = indexId;
                
                const select = document.getElementById('assign-user-id');
                select.innerHTML = '<option value="">-- è¯·é€‰æ‹©ç”¨æˆ· --</option>';
                
                allUsers.filter(u => !assignedUserIds.has(u.id) && u.status === 1).forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = `${user.nickname || user.username} (${user.email || user.phone || 'ID: ' + user.id})`;
                    select.appendChild(option);
                });

                document.getElementById('assign-modal').classList.add('active');
            } catch (e) {
                showToast('åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥', 'error');
            }
        }

        function closeAssignModal() {
            document.getElementById('assign-modal').classList.remove('active');
        }

        async function handleAssignSubmit(event) {
            event.preventDefault();
            
            const userId = document.getElementById('assign-user-id').value;

            try {
                const res = await fetch(`${POOL_API}/assign/${userId}`, {
                    method: 'POST'
                });

                if (res.ok) {
                    showToast('ç´¢å¼•å·²åˆ†é…ç»™ç”¨æˆ·', 'success');
                    closeAssignModal();
                    loadPool();
                    loadPoolStats();
                    loadUsers();
                } else {
                    const data = await res.json();
                    showToast(data.error || 'åˆ†é…å¤±è´¥', 'error');
                }
            } catch (e) {
                showToast('åˆ†é…å¤±è´¥', 'error');
            }
        }

        async function releaseIndex(userId) {
            if (!confirm('ç¡®å®šè¦é‡Šæ”¾æ­¤ç”¨æˆ·çš„ç´¢å¼•å—ï¼Ÿç”¨æˆ·å°†æ— æ³•ç»§ç»­ä½¿ç”¨çŸ¥è¯†åº“åŠŸèƒ½ã€‚')) {
                return;
            }

            try {
                const res = await fetch(`${POOL_API}/release/${userId}`, { method: 'POST' });
                if (res.ok) {
                    showToast('ç´¢å¼•å·²é‡Šæ”¾', 'success');
                    loadPool();
                    loadPoolStats();
                    loadUsers();
                } else {
                    showToast('é‡Šæ”¾å¤±è´¥', 'error');
                }
            } catch (e) {
                showToast('é‡Šæ”¾å¤±è´¥', 'error');
            }
        }

        async function disableIndex(id) {
            try {
                const res = await fetch(`${POOL_API}/${id}/disable`, { method: 'POST' });
                if (res.ok) {
                    showToast('ç´¢å¼•å·²ç¦ç”¨', 'success');
                    loadPool();
                    loadPoolStats();
                } else {
                    showToast('ç¦ç”¨å¤±è´¥', 'error');
                }
            } catch (e) {
                showToast('ç¦ç”¨å¤±è´¥', 'error');
            }
        }

        async function enableIndex(id) {
            try {
                const res = await fetch(`${POOL_API}/${id}/enable`, { method: 'POST' });
                if (res.ok) {
                    showToast('ç´¢å¼•å·²å¯ç”¨', 'success');
                    loadPool();
                    loadPoolStats();
                } else {
                    showToast('å¯ç”¨å¤±è´¥', 'error');
                }
            } catch (e) {
                showToast('å¯ç”¨å¤±è´¥', 'error');
            }
        }

        async function deleteIndex(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤ç´¢å¼•å—ï¼Ÿ')) {
                return;
            }

            try {
                const res = await fetch(`${POOL_API}/${id}`, { method: 'DELETE' });
                if (res.ok) {
                    showToast('ç´¢å¼•å·²åˆ é™¤', 'success');
                    loadPool();
                    loadPoolStats();
                } else {
                    const data = await res.json();
                    showToast(data.error || 'åˆ é™¤å¤±è´¥', 'error');
                }
            } catch (e) {
                showToast('åˆ é™¤å¤±è´¥', 'error');
            }
        }

        // ========================
        // Utility Functions
        // ========================

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Close modals on overlay click
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.classList.remove('active');
                }
            });
        });

        // Close modal on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('active'));
            }
        });

        // Initialize
        loadUserStats();
        loadUsers();
    </script>
</body>
</html>
